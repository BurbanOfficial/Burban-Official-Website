<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Cart</title>
  <!-- Fonts et icônes -->
  <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <!-- Firebase SDK (compat version) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    // Tes identifiants Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDb4AOtRT7jGENnLZ2KNwpczaG2Z77G2rc",
      authDomain: "burban-fidelity.firebaseapp.com",
      projectId: "burban-fidelity",
      storageBucket: "burban-fidelity.firebasestorage.app",
      messagingSenderId: "830299174800",
      appId: "1:830299174800:web:f50a4ec419e108f7f16515",
      measurementId: "G-E4QD4PYLM5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
  </script>
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    /* RESET & TYPO */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Satoshi',sans-serif; background:#fafafa; color:#111; padding:20px; }
    h1 { text-align:center; font-size:28px; margin-bottom:20px; font-weight:700; }

    /* WRAPPER PRINCIPAL */
    .cart-wrapper {
      display: flex;
      flex-wrap: wrap;
      max-width:1200px;
      margin:0 auto;
      background:#fff;
      padding:20px;
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,0.08);
      gap:20px;
    }

    /* COLONNE ARTICLES */
    .cart-items-container { flex:2 1 400px; }
    .cart-item {
      display:flex; align-items:center;
      padding:15px 0; border-bottom:1px solid #eee;
      flex-wrap: wrap;
    }
    .cart-item:last-child { border-bottom:none; }
    .cart-item img {
      width:60px; height:60px; object-fit:cover;
      border-radius:10px; margin-right:15px;
      flex-shrink: 0;
    }
    .item-details {
      flex:1 1 200px; display:flex; flex-direction:column;
      margin-top: 10px;
    }
    .item-title { font-size:16px; font-weight:600; margin-bottom:5px; }
    .item-price { font-size:14px; color:#666; }
    .quantity-controls {
      display:flex; align-items:center; margin-top:8px;
    }
    .quantity-controls button {
      background:none; border:1px solid #ccc;
      padding:5px 10px; border-radius:8px;
      font-size:16px; cursor:pointer;
      transition:background 0.2s;
    }
    .quantity-controls button:hover { background:#f2f2f2; }
    .quantity-controls input {
      width:40px; text-align:center;
      margin:0 8px;
      border:1px solid #ddd; border-radius:8px;
      padding:4px 0;
    }
    .remove-button {
      background:none; border:none;
      color:#e63946; font-size:20px;
      margin-left:10px; cursor:pointer;
      transition:color 0.2s;
    }
    .remove-button:hover { color:#c92a2a; }

    /* COLONNE RÉCAPITULATIF */
    .cart-summary {
      flex:1 1 300px;
      background:#f7f7f7; padding:20px;
      border-radius:16px;
      display:flex; flex-direction:column;
      height: fit-content;
    }
    .total {
      font-size:20px; font-weight:700;
      margin-bottom:15px; text-align:right; color:#111;
    }
    #voucher-section { margin-bottom:15px; }
    #voucher-section h3 {
      font-size:18px; margin-bottom:8px; font-weight:600;
    }
    #voucher-section p,
    #voucher-section label { font-size:14px; color:#555; }

    .checkout-btn {
      display:flex; align-items:center; justify-content:center;
      width:100%; padding:12px 0;
      background:#111; color:#fff;
      font-size:16px; font-weight:600;
      border:none; border-radius:12px;
      cursor:pointer; transition:background 0.3s;
    }
    .checkout-btn:hover { background:#333; }
    .checkout-btn:disabled { background:#888; cursor:not-allowed; }

    .loader {
      margin-left:8px; width:18px; height:18px;
      border-radius:50%;
      border:3px solid #fff; border-top:3px solid #111;
      animation:spin 1s linear infinite;
      display:none;
    }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
    #card-icon { margin-left:8px; font-size:18px; }

    /* ÉTAT PANIER VIDE */
    .empty-cart {
      text-align:center; padding:40px 10px;
    }
    .empty-cart p {
      font-size:18px; margin-bottom:15px; color:#555;
    }
    .empty-btn {
      background:#111; color:#fff;
      border:none; padding:10px 25px;
      border-radius:30px;
      font-size:14px; font-weight:600;
      cursor:pointer; transition:background 0.3s;
    }
    .empty-btn:hover { background:#333; }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .cart-wrapper { flex-direction: column; padding:15px; }
      .cart-item { flex-direction: column; align-items: flex-start; }
      .cart-item img { margin-bottom:10px; }
      .item-details { margin-top:0; }
      .quantity-controls { margin-top:5px; }
      .cart-summary { width:100%; }
    }
  </style>
</head>
<body>
  <h1>My Cart</h1>
  <div class="cart-wrapper">
    <!-- GAUCHE : ARTICLES OU PANIER VIDE -->
    <div class="cart-items-container" id="cart-items"></div>

    <!-- DROITE : RÉCAPITULATIF -->
    <div class="cart-summary">
      <div class="total">Total : <span id="cart-total">0.00€</span></div>

      <div id="voucher-section">
        <h3>Available discount coupons/Coupons de réduction disponibles</h3>
        <div id="voucher-options">
          <p>Loading/Chargement...</p>
        </div>
      </div>

      <button id="checkout-btn" class="checkout-btn" onclick="handleCheckout()">
        <span id="checkout-btn-text">Proceed to payment</span>
        <div class="loader" id="loader"></div>
        <span id="card-icon"><i class="fa-solid fa-credit-card"></i></span>
      </button>
    </div>
  </div>

  <script>
    // Redirection vers la boutique
    function goShop() {
      window.location.href = 'https://burbanofficial.com';
    }

    // --- Chargement et gestion du panier ---
    function loadCart() {
      const container = document.getElementById('cart-items');
      const items = JSON.parse(localStorage.getItem('cartItems')) || [];

      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-cart">
            <p>Votre panier est vide.</p>
            <button class="empty-btn" onclick="goShop()">Retourner à la boutique</button>
          </div>`;
        document.querySelector('.cart-summary').style.display = 'none';
        return;
      }

      document.querySelector('.cart-summary').style.display = 'flex';
      container.innerHTML = '';

      items.forEach((item, i) => {
        const el = document.createElement('div');
        el.className = 'cart-item';
        el.innerHTML = `
          <img src="${item.image}" alt="${item.name}">
          <div class="item-details">
            <span class="item-title">${item.name}</span>
            <span class="item-price">${item.price.toFixed(2)}€</span>
            <div class="quantity-controls">
              <button onclick="updateQuantity(${i}, -1)">-</button>
              <input type="text" value="${item.quantity}" readonly>
              <button onclick="updateQuantity(${i}, 1)">+</button>
              <button class="remove-button" onclick="removeItem(${i})">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>`;
        container.appendChild(el);
      });

      updateTotal();
    }

    // Modifier la quantité
    function updateQuantity(index, delta) {
      const items = JSON.parse(localStorage.getItem('cartItems')) || [];
      if (!items[index]) return;
      items[index].quantity += delta;
      if (items[index].quantity < 1) items.splice(index, 1);
      localStorage.setItem('cartItems', JSON.stringify(items));
      loadCart();
    }

    function removeItem(index) {
      const items = JSON.parse(localStorage.getItem('cartItems')) || [];
      items.splice(index, 1);
      localStorage.setItem('cartItems', JSON.stringify(items));
      loadCart();
    }

    // --- Total & vouchers ---
    async function getUserPoints() {
      try {
        const user = auth.currentUser;
        if (user) {
          const doc = await db.collection('users').doc(user.uid).get();
          return doc.exists ? doc.data().points || 0 : 0;
        }
        return 0;
      } catch {
        return 0;
      }
    }

    function addVoucherCheckboxListeners() {
      const cbs = document.querySelectorAll('input.voucher-checkbox');
      cbs.forEach(cb => {
        cb.addEventListener('click', () => {
          if (cb.checked) {
            cbs.forEach(other => { if (other !== cb) other.checked = false; });
          } else cb.checked = false;
        });
      });
    }

    function updateVoucherOptions() {
      const div = document.getElementById('voucher-options');
      if (!auth.currentUser) {
        div.innerHTML = `<p style="font-style:italic; color:#a00;">Log in to view your discount coupons.</p>`;
      } else {
        getUserPoints().then(points => {
          const total = parseFloat(document.getElementById('cart-total').innerText.replace('€',''));
          const vouchers = [
            { points:500,value:5,min:30 },
            { points:1000,value:10,min:40 },
            { points:2000,value:20,min:80 },
            { points:2500,value:30,min:100 }
          ];
          let html = '';
          vouchers.forEach(v => {
            if (points>=v.points) {
              if (total>=v.min) {
                html += `<div style="margin-bottom:8px;">
                  <input type="checkbox" class="voucher-checkbox" id="v${v.value}" value="${v.value}" data-points="${v.points}">
                  <label for="v${v.value}" style="cursor:pointer;">€${v.value} coupon (cost ${v.points} points)</label>
                </div>`;
              } else {
                html += `<div style="margin-bottom:8px;color:#aaa;">
                  €${v.value} coupon (min. purchase €${v.min}) <em>Not applicable.</em>
                </div>`;
              }
            }
          });
          div.innerHTML = html||'<p>No discount coupons available.</p>';
          addVoucherCheckboxListeners();
        });
      }
    }

    function updateTotal() {
      const items = JSON.parse(localStorage.getItem('cartItems')) || [];
      const total = items.reduce((s,it)=>s+it.price*it.quantity,0);
      document.getElementById('cart-total').innerText = total.toFixed(2)+'€';
      updateVoucherOptions();
    }

    // --- Checkout Stripe ---
    function resetButton() {
      const btn = document.getElementById('checkout-btn');
      document.getElementById('checkout-btn-text').style.display='inline';
      document.getElementById('loader').style.display='none';
      document.getElementById('card-icon').style.display='inline-block';
      btn.disabled = false;
    }

    async function handleCheckout() {
      const btn = document.getElementById('checkout-btn');
      btn.disabled = true;
      document.getElementById('checkout-btn-text').style.display='none';
      document.getElementById('loader').style.display='inline-block';
      document.getElementById('card-icon').style.display='none';

      const sel = document.querySelector('input.voucher-checkbox:checked');
      const voucher = sel ? { voucherValue: sel.value, voucherPoints: sel.dataset.points } : null;
      if (voucher) localStorage.setItem('appliedVoucher', JSON.stringify(voucher));
      else localStorage.removeItem('appliedVoucher');

      try {
        const items = JSON.parse(localStorage.getItem('cartItems'))||[];
        if (!items.length) { alert("Your cart is empty!"); resetButton(); return; }
        const resp = await fetch('https://burban-stripe-service.onrender.com/create-checkout-session', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ items, voucher })
        });
        const data = await resp.json();
        if (data.error) { alert(data.error); resetButton(); return; }
        resetButton();
        Stripe('pk_live_51Q9ORzRwel3656rYkt2acyiz7KoCl1mJA6ru04LPlGQmt5Iw9BcTQa16qv5O0Ozte9bMCtutah1qh4r6yds3l2p000MPG83KmB')
          .redirectToCheckout({ sessionId: data.sessionId });
      } catch (e) {
        console.error(e);
        alert("An error has occurred. Please try again.");
        resetButton();
      }
    }

    // Mise à jour vouchers à l'auth
    auth.onAuthStateChanged(() => updateVoucherOptions());

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loader').style.display = 'none';
      loadCart();
    });
  </script>
</body>
</html>
