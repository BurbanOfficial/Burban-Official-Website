<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Cart</title>
  <!-- Fonts et icônes -->
  <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <!-- Favicon -->
  <link rel="icon" href="https://burbanofficial.com/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="https://burbanofficial.com/favicon.png">
  <link rel="icon" href="https://burbanofficial.com/favicon.png" sizes="16x16" />
  <link rel="icon" href="https://burbanofficial.com/favicon.png" sizes="32x32" />
  <link rel="icon" href="https://burbanofficial.com/favicon.png" sizes="48x48" />

  <!-- Firebase SDK (compat version) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    // Remplacez ces valeurs par vos identifiants Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDb4AOtRT7jGENnLZ2KNwpczaG2Z77G2rc",
      authDomain: "burban-fidelity.firebaseapp.com",
      projectId: "burban-fidelity",
      storageBucket: "burban-fidelity.firebasestorage.app",
      messagingSenderId: "830299174800",
      appId: "1:830299174800:web:f50a4ec419e108f7f16515",
      measurementId: "G-E4QD4PYLM5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
  </script>
  
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    /* RESET & TYPO */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Satoshi',sans-serif; background:#fafafa; color:#111; padding:20px; }
    h1 { text-align:center; font-size:32px; margin-bottom:30px; font-weight:700; }

    /* WRAPPER PRINCIPAL */
    .cart-wrapper {
      display:flex;
      max-width:1200px;
      margin:0 auto;
      background:#fff;
      padding:30px;
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,0.08);
      gap:30px;
    }

    /* COLONNE ARTICLES */
    .cart-items-container { flex:2; }
    .cart-item {
      display:flex; align-items:center;
      padding:20px 0; border-bottom:1px solid #eee;
    }
    .cart-item:last-child { border-bottom:none; }
    .cart-item img {
      width:70px; height:70px; object-fit:cover;
      border-radius:10px; margin-right:20px;
    }
    .item-details {
      flex:1; display:flex; flex-direction:column;
    }
    .item-title { font-size:18px; font-weight:600; margin-bottom:5px; }
    .item-price { font-size:16px; color:#666; }
    .quantity-controls {
      display:flex; align-items:center; margin-top:10px;
    }
    .quantity-controls button {
      background:none; border:1px solid #ccc;
      padding:5px 10px; border-radius:8px;
      font-size:16px; cursor:pointer;
      transition:background 0.2s;
    }
    .quantity-controls button:hover { background:#f2f2f2; }
    .quantity-controls input {
      width:50px; text-align:center;
      margin:0 10px;
      border:1px solid #ddd; border-radius:8px;
      padding:5px 0;
    }
    .remove-button {
      background:none; border:none;
      color:#e63946; font-size:22px;
      margin-left:15px; cursor:pointer;
      transition:color 0.2s;
    }
    .remove-button:hover { color:#c92a2a; }

    /* COLONNE RÉCAPITULATIF */
    .cart-summary {
      flex:1;
      background:#f7f7f7; padding:20px;
      border-radius:16px;
      display:flex; flex-direction:column;
      height:fit-content;
    }
    .total {
      font-size:24px; font-weight:700;
      margin-bottom:20px; text-align:right; color:#111;
    }
    #voucher-section { margin-bottom:20px; }
    #voucher-section h3 {
      font-size:20px; margin-bottom:10px; font-weight:600;
    }
    #voucher-section p,
    #voucher-section label { font-size:16px; color:#555; }

    .checkout-btn {
      display:flex; align-items:center; justify-content:center;
      width:100%; padding:15px 0;
      background:#111; color:#fff;
      font-size:18px; font-weight:600;
      border:none; border-radius:12px;
      cursor:pointer; transition:background 0.3s;
    }
    .checkout-btn:hover { background:#333; }
    .checkout-btn:disabled { background:#888; cursor:not-allowed; }

    .loader {
      margin-left:10px; width:20px; height:20px;
      border-radius:50%;
      border:3px solid #fff; border-top:3px solid #111;
      animation:spin 1s linear infinite;
      display:none;
    }
    @keyframes spin {
      0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);}
    }
    #card-icon { margin-left:10px; font-size:20px; }

    /* ÉTAT PANIER VIDE */
    .empty-cart {
      text-align:center; padding:60px 20px;
    }
    .empty-cart p {
      font-size:20px; margin-bottom:20px; color:#555;
    }
    .empty-btn {
      background:#111; color:#fff;
      border:none; padding:12px 30px;
      border-radius:30px;
      font-size:16px; font-weight:600;
      cursor:pointer; transition:background 0.3s;
    }
    .empty-btn:hover { background:#333; }
  </style>
</head>
<body>
  <div class="cart-container">
    <h1>My Cart</h1>
    <div class="cart-wrapper">
    <!-- Colonne gauche : articles -->
    <div class="cart-items-container" id="cart-items"></div>
    
    <!-- Colonne droite : résumé + paiement -->
    <div class="cart-summary">
      <div class="total">Total : <span id="cart-total">0.00€</span></div>
    
    <!-- Section Bons de réduction / Message optionnel de connexion -->
    <div id="voucher-section">
      <h3>Available discount coupons/Coupons de réduction disponibles</h3>
      <div id="voucher-options">
        <p>Loading/Chargement...</p>
      </div>
    </div>
    
    <!-- Bouton de paiement -->
    <button id="checkout-btn" class="checkout-btn" onclick="handleCheckout()">
      <span id="checkout-btn-text">Proceed to payment</span>
      <div class="loader" id="loader" style="display:none;"></div>
      <span id="card-icon"><i class="fa-solid fa-credit-card"></i></span>
    </button>
  </div>

  <script>
    function goShop() {
      // change ici vers l’URL de ta boutique
      window.location.href = 'https://burbanofficial.com';
    }

    // --- Chargement et gestion du panier ---
    function loadCart() {
      const container = document.getElementById('cart-items');
      const items = JSON.parse(localStorage.getItem('cartItems')) || [];
      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-cart">
            <p>Votre panier est vide.</p>
            <button class="empty-btn" onclick="goShop()">Retourner à la boutique</button>
          </div>`;
        document.querySelector('.cart-summary').style.display = 'none';
        return;
      }
      // sinon on affiche les articles
      document.querySelector('.cart-summary').style.display = 'flex';
      container.innerHTML = '';
      items.forEach((item, i) => {
        const el = document.createElement('div');
        el.className = 'cart-item';
        el.innerHTML = `
          <img src="${item.image}" alt="${item.title}">
          <div class="item-details">
            <span class="item-title">${item.title}</span>
            <span class="item-price">${item.price.toFixed(2)}€</span>
            <div class="quantity-controls">
              <button onclick="changeQuantity(${i}, -1)">-</button>
              <input type="text" value="${item.quantity}" readonly>
              <button onclick="changeQuantity(${i}, 1)">+</button>
              <button class="remove-button" onclick="removeItem(${i})"><i class="fas fa-times"></i></button>
            </div>
          </div>`;
        container.appendChild(el);
      });
      updateTotal();
    }

    function updateQuantity(index, delta) {
      let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
      let newQuantity = parseInt(cartItems[index].quantity) + delta;
      if (newQuantity < 1) newQuantity = 1;
      if (newQuantity > 10) newQuantity = 10;
      cartItems[index].quantity = newQuantity;
      localStorage.setItem('cartItems', JSON.stringify(cartItems));
      loadCart();
    }

    function changeQuantity(index, value) {
      let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
      let newQuantity = parseInt(value);
      if (newQuantity < 1) newQuantity = 1;
      if (newQuantity > 10) newQuantity = 10;
      cartItems[index].quantity = newQuantity;
      localStorage.setItem('cartItems', JSON.stringify(cartItems));
      loadCart();
    }

    function removeItem(index) {
      let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
      cartItems.splice(index, 1);
      localStorage.setItem('cartItems', JSON.stringify(cartItems));
      loadCart();
    }

    // --- Gestion des points de fidélité et des bons de réduction ---
    async function getUserPoints() {
      try {
        const user = auth.currentUser;
        if (user) {
          const docRef = db.collection('users').doc(user.uid);
          const doc = await docRef.get();
          if (doc.exists) {
            return doc.data().points || 0;
          }
        }
        return 0;
      } catch (error) {
        console.error("Error while retrieving points:", error);
        return 0;
      }
    }

    // Met à jour l'affichage de la section bons.
    // Si l'utilisateur n'est pas connecté, on affiche un message sans bloquer le paiement.
    function updateVoucherOptions() {
      const voucherOptionsDiv = document.getElementById('voucher-options');
      if (!auth.currentUser) {
        voucherOptionsDiv.innerHTML = `<p style="font-style: italic; color: #a00;">Log in to view your discount coupons.</p>`;
      } else {
        getUserPoints().then(points => {
          const cartTotalText = document.getElementById('cart-total').innerText;
          const cartTotal = parseFloat(cartTotalText.replace('€','').trim());
          
          let voucherHTML = '';
          const vouchers = [
            { points: 500, value: 5, minPurchase: 30 },
            { points: 1000, value: 10, minPurchase: 40 },
            { points: 2000, value: 20, minPurchase: 80 },
            { points: 2500, value: 30, minPurchase: 100 }
          ];
      
          vouchers.forEach(voucher => {
            if (points >= voucher.points) {
              if (cartTotal >= voucher.minPurchase) {
                voucherHTML += `<div style="margin-bottom: 8px;">
                  <input type="checkbox" class="voucher-checkbox" id="voucher-${voucher.value}" value="${voucher.value}" data-points="${voucher.points}">
                  <label for="voucher-${voucher.value}" style="cursor: pointer;">€${voucher.value} coupon (cost ${voucher.points} points)</label>
                </div>`;
              } else {
                voucherHTML += `<div style="margin-bottom: 8px; color: #aaa;">
                  €${voucher.value} coupon (min. purchase €${voucher.minPurchase} - cost ${voucher.points} points) <em>Not applicable.</em>
                </div>`;
              }
            }
          });
      
          if (voucherHTML === '') {
            voucherHTML = `<p>No discount coupons available at the moment.</p>`;
          }
          voucherOptionsDiv.innerHTML = voucherHTML;
          addVoucherCheckboxListeners();
        });
      }
    }

    // Permet de gérer le comportement de sélection exclusive (mais déselectionnable) des vouchers
    function addVoucherCheckboxListeners() {
      const checkboxes = document.querySelectorAll('input.voucher-checkbox');
      checkboxes.forEach(cb => {
        cb.addEventListener('click', function() {
          if (this.checked) {
            // Uncheck all others
            checkboxes.forEach(other => {
              if (other !== this) {
                other.checked = false;
              }
            });
          } else {
            // Si l'utilisateur clique sur un voucher déjà sélectionné, il le désélectionne
            this.checked = false;
          }
        });
      });
    }

    function updateTotal() {
      const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
      const total = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
      document.getElementById('cart-total').innerText = total.toFixed(2) + '€';
      updateVoucherOptions();
    }

    function resetButton() {
      const checkoutBtn = document.getElementById('checkout-btn');
      const checkoutBtnText = document.getElementById('checkout-btn-text');
      const loader = document.getElementById('loader');
      const cardIcon = document.getElementById('card-icon');
      checkoutBtn.disabled = false;
      checkoutBtnText.style.display = 'inline';
      loader.style.display = 'none';
      cardIcon.style.display = 'inline-block';
    }

    // --- Paiement via Stripe ---
    async function handleCheckout() {
      const checkoutBtn = document.getElementById('checkout-btn');
      const checkoutBtnText = document.getElementById('checkout-btn-text');
      const loader = document.getElementById('loader');
      const cardIcon = document.getElementById('card-icon');
      
      checkoutBtn.disabled = true;
      checkoutBtnText.style.display = 'none';
      loader.style.display = 'inline-block';
      cardIcon.style.display = 'none';
      
      // Si un voucher est sélectionné, on le stocke
      const selectedVoucher = document.querySelector('input.voucher-checkbox:checked');
      let voucherData = null;
      if (selectedVoucher) {
        const voucherValue = selectedVoucher.value;
        const voucherPoints = selectedVoucher.getAttribute('data-points');
        voucherData = { voucherValue, voucherPoints };
        localStorage.setItem('appliedVoucher', JSON.stringify(voucherData));
      } else {
        localStorage.removeItem('appliedVoucher');
      }
    
      try {
        const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
        if (cartItems.length === 0) {
          alert("Your cart is empty!");
          resetButton();
          return;
        }
        // Inclure le voucher (s'il existe) dans la requête envoyée au serveur
        const response = await fetch('https://burban-stripe-service.onrender.com/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: cartItems, voucher: voucherData })
        });
        const data = await response.json();
        if (data.error) {
          alert(data.error);
          resetButton();
          return;
        }
        resetButton();
        const stripe = Stripe('pk_live_51Q9ORzRwel3656rYkt2acyiz7KoCl1mJA6ru04LPlGQmt5Iw9BcTQa16qv5O0Ozte9bMCtutah1qh4r6yds3l2p000MPG83KmB');
        stripe.redirectToCheckout({ sessionId: data.sessionId });
      } catch (error) {
        console.error(error);
        alert("An error has occurred. Please try again.");
        resetButton();
      }
    }

    // --- Mise à jour des vouchers en fonction de l'état d'authentification ---
    auth.onAuthStateChanged(user => {
      updateVoucherOptions();
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loader').style.display = 'none';
      loadCart();
    });
  </script>
</body>
</html>
